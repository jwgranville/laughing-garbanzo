<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Laughing Garbanzo</title>
  <!-- Project metadata -->
  <meta name="author" content="Joe Granville">
  <meta name="date" content="2026-01-23T04:26:09+00:00">
  <meta name="email" content="874605+jwgranville@users.noreply.github.com">
  <meta name="version" content="0.1.0">
  <meta name="license" content="MIT">
  <meta name="status" content="Proof-of-concept">
  <style>
    canvas { border: 1px solid black; }
  </style>
</head>
<body>

  <p>Server is running!</p>
  
  <p><input id="text" placeholder="Type here..." /></p>
  
  <p><canvas id="canvas" width="600" height="400"></canvas></p>

  <script>
    console.log('script is running');
    
    const ws = new WebSocket(`ws://${location.host}`);
    
    const DomainEvents = {
      STATE_INIT: 'stateInitialization',
      UPDATE_TEXT: 'updateText',
      MOVE: 'move'
    };
    
    const input = document.getElementById('text');
    input.addEventListener('input', e => {
      ws.send(JSON.stringify({
        command: DomainEvents.UPDATE_TEXT,
        objId: 'text-1',
        value: e.target.value
      }));
    });
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const strokes = {};
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      Object.values(strokes).forEach(stroke => {
        ctx.strokeStyle = stroke.color || 'black';
        ctx.lineWidth = stroke.width || 1;
        ctx.beginPath();
        ctx.moveTo(stroke.x1, stroke.y1);
        ctx.lineTo(stroke.x2, stroke.y2);
        ctx.stroke();
      });
    }
    draw();
    let dragging = false;
    let lastPosition = null;
    let selectedId = null;
    canvas.addEventListener('mousedown', e => {
      dragging = true;
      lastPosition = { x: e.offsetX, y: e.offsetY };
    });
    canvas.addEventListener('mouseup', () => {
      dragging = false;
      lastPosition = null;
    });
    canvas.addEventListener('mousemove', e => {
      if (!dragging || !lastPosition) return;
      const dx = e.offsetX - lastPosition.x;
      const dy = e.offsetY - lastPosition.y;
      const stroke = strokes[selectedId];
      if (stroke) {
        stroke.x1 += dx;
        stroke.y1 += dy;
        stroke.x2 += dx;
        stroke.y2 += dy;
        draw();
      }
      ws.send(JSON.stringify({
        command: DomainEvents.MOVE,
        objId: selectedId,
        dx,
        dy
      }));
      lastPosition = { x: e.offsetX, y: e.offsetY };
    });

    ws.onmessage = e => {
      console.log('ws message:', e.data);
      const msg = JSON.parse(e.data);
      
      if (msg.type === DomainEvents.MOVE && msg.objId === selectedId) {
        const stroke = strokes[selectedId];
        if (!stroke) return;
        const alpha = 0.2;
        stroke.x1 += (msg.x1 - stroke.x1) * alpha;
        stroke.y1 += (msg.y1 - stroke.y1) * alpha;
        stroke.x2 += (msg.x2 - stroke.x2) * alpha;
        stroke.y2 += (msg.y2 - stroke.y2) * alpha;
        draw();
      }
      
      if (msg.type === DomainEvents.UPDATE_TEXT) {
        const input = document.getElementById('text');
        if (input.value !== msg.value) {
          input.value = msg.value;
        }
      }
      
      if (msg.type === DomainEvents.STATE_INIT) {
        if (msg.state.stroke) {
          strokes[msg.objId] = msg.state.stroke;
          console.log('strokes after stateInitialization', strokes);
          
          if (selectedId == null) {
            selectedId = msg.objId;
          }
          
          draw();
        }
        
        if (typeof msg.state.text === 'string' ) {
          const input = document.getElementById('text');
          input.value = msg.state.text;
        }
      }
    };
  </script>

</body>
</html>
